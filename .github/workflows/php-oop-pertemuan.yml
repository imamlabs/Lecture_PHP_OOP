name: PHP OOP - Latihan per Pertemuan

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  run-pertemuan:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - dir: Pertemuan01
            entry: HelloWorld.php
          - dir: Pertemuan02
            entry: Main.php
          - dir: Pertemuan03
            entry: Main.php
          - dir: Pertemuan04
            entry: Main.php
          - dir: Pertemuan05
            entry: Main.php
          - dir: Pertemuan06
            entry: Main.php
          - dir: Pertemuan07
            entry: Main.php
          - dir: Pertemuan08
            skip: true
          - dir: Pertemuan09
            entry: Main.php
          - dir: Pertemuan10
            entry: Main.php
          - dir: Pertemuan11
            entry: Main.php
          - dir: Pertemuan12
            entry: Main.php
          - dir: Pertemuan13
            entry: Main.php
          - dir: Pertemuan14
            entry: Main.php
          - dir: Pertemuan15
            entry: Main.php
          - dir: Pertemuan16
            entry: App.php

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          ini-values: |
            memory_limit=512M
            error_reporting=E_ALL
            display_errors=On

      - name: Resolve base dir
        id: basedir
        run: |
          if [ -d "php-oop-multifile" ]; then
            echo "value=php-oop-multifile" >> "$GITHUB_OUTPUT"
          else
            echo "value=." >> "$GITHUB_OUTPUT"
          fi
          echo "Using BASE_DIR=$(cat $GITHUB_OUTPUT | sed -n 's/value=//p')"

      - name: Skip marker
        if: matrix.skip == 'true'
        run: echo "Skipping ${{ matrix.dir }} (no PHP files)"

      - name: List folder (debug)
        if: matrix.skip != 'true'
        run: |
          echo "Workspace:"
          ls -la
          echo "Trying ${{ steps.basedir.outputs.value }}/${{ matrix.dir }}:"
          ls -la "${{ steps.basedir.outputs.value }}/${{ matrix.dir }}" || true

      - name: Run ${{ matrix.dir }} -> ${{ matrix.entry }}
        if: matrix.skip != 'true'
        shell: bash
        run: |
          set -e
          BASE="${{ steps.basedir.outputs.value }}"
          RUN_DIR="$BASE/${{ matrix.dir }}"
          if [ ! -d "$RUN_DIR" ]; then
            echo "Folder tidak ditemukan: $RUN_DIR"
            exit 2
          fi
          cd "$RUN_DIR"
          if [ ! -f "${{ matrix.entry }}" ]; then
            echo "Entry file tidak ditemukan: $RUN_DIR/${{ matrix.entry }}"
            echo "Daftar file:"
            ls -la
            exit 3
          fi
          php "${{ matrix.entry }}"

      - name: Upload output (opsional)
        if: always() && matrix.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: output-${{ matrix.dir }}
          path: |
            ${{ steps.basedir.outputs.value }}/${{ matrix.dir }}/output*.txt
          if-no-files-found: ignore
